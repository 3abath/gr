<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Wardrobe Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for modal and animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.75);
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-in-out;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .app-container {
            min-height: calc(100vh - 4rem); /* Adjust for nav bar height */
            padding-bottom: 4rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    
    <!-- App Container -->
    <div id="app" class="app-container">
        <!-- Content will be dynamically rendered here by JavaScript -->
    </div>

    <!-- Alert Message Container -->
    <div id="alert-container"></div>

    <!-- Modal for adding/editing new items -->
    <div id="add-item-modal" class="fixed inset-0 flex items-center justify-center p-4 z-50 modal-bg hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-gray-200">Add New Item</h2>
                <button id="close-modal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                </button>
            </div>
            <p class="text-gray-400 mb-4">
                Adding to: <span id="modal-subcategory" class="font-semibold text-white"></span>
            </p>
            <input type="text" id="new-item-name" placeholder="Enter item name (e.g., Blue T-shirt)" class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <label class="block text-gray-400 mb-2">Upload Photo</label>
            <input type="file" id="item-image-upload" accept="image/*" class="w-full mb-4 text-gray-400
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-indigo-500 file:text-white
                hover:file:bg-indigo-600" />
            <div id="image-preview-container" class="mb-4 hidden">
                <h3 class="text-gray-400 text-sm mb-2">Image Preview:</h3>
                <img id="image-preview" src="#" alt="Selected Preview" class="w-full h-32 object-contain rounded-lg border border-gray-700 p-1" />
            </div>
            <button id="add-item-button" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50" disabled>
                Add Item
            </button>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div id="nav-bar" class="fixed bottom-0 left-0 right-0 bg-gray-900 text-white shadow-lg z-50 hidden">
        <div class="flex justify-around py-2">
            <button id="nav-wardrobe" class="flex flex-col items-center p-2 rounded-xl transition-colors text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shirt"><path d="M20.3 10.9c.5 1.5.7 3.1.5 4.7-.1 1.6-.8 3.1-1.7 4.3-.9 1.2-2.1 2.1-3.6 2.5-1.5.4-3.1.4-4.6.1-1.5-.3-2.9-1.1-4.1-2.1-1.2-1-2.1-2.2-2.5-3.6-.4-1.5-.4-3.1-.1-4.6"/><path d="M14.5 10.5c.9-.7 1.3-1.8 1.3-3.2 0-1.2-.4-2.3-1.1-3.2-.8-.9-1.8-1.5-3.1-1.5s-2.3.6-3.1 1.5c-.8.9-1.1 2-1.1 3.2 0 1.4.4 2.5 1.3 3.2"/><path d="M9 10c0 2-2 4-2 4h-2l-3-2V6l3-2h2s2 2 2 4z"/><path d="M15 10c0 2 2 4 2 4h2l3-2V6l-3-2h-2s-2 2-2 4z"/></svg>
                <span class="text-xs mt-1">Wardrobe</span>
            </button>
            <button id="nav-create-outfit" class="flex flex-col items-center p-2 rounded-xl transition-colors text-gray-400 hover:text-indigo-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.9 2.5a1.8 1.8 0 0 1-3.6 0L4.5 3"/><path d="m20.5 8.5-1.9 2.5a1.8 1.8 0 0 1-3.6 0L15.5 8.5"/><path d="M12 18-1.9 2.5a1.8 1.8 0 0 1-3.6 0L4.5 18"/></svg>
                <span class="text-xs mt-1">Create Outfit</span>
            </button>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script type="module">
        // --- Application State ---
        // This object holds all the application data in memory.
        const state = {
            gender: null,
            currentPage: 'wardrobe',
            wardrobe: {},
            currentOutfit: [],
            editingItem: null, // Tracks the item being edited
            modalData: {}, // Holds data for the modal
            selectedImage: null, // Temporarily stores the selected image data
        };

        // --- Wardrobe & Outfit Data ---
        const menCategories = {
            "Tops": ["T-shirts", "Polo shirts", "Shirts (casual/formal)", "Sweaters", "Cardigans", "Sweatshirts / Hoodies", "Tank tops"],
            "Bottoms": ["Jeans", "Trousers / Slacks", "Chinos", "Shorts", "Cargo pants", "Joggers / Sweatpants"],
            "Outerwear": ["Jackets", "Blazers", "Coats", "Parkas", "Raincoats", "Vests / Gilets"],
            "Activewear & Sportswear": ["Sports T-shirts / Tanks", "Tracksuits", "Gym shorts", "Running jackets"],
            "Loungewear & Sleepwear": ["Pajamas", "Robes", "Lounge pants", "Sleep shirts"],
            "Underwear": ["Boxers", "Briefs", "Trunks", "Undershirts"],
            "Swimwear": ["Swim trunks", "Board shorts"],
            "Accessories": ["Hats / Caps", "Scarves", "Gloves", "Belts", "Ties / Bowties", "Sunglasses", "Watches", "Bags / Backpacks"]
        };
        const womenCategories = {
            "Tops": ["T-shirts", "Blouses", "Shirts", "Sweaters", "Cardigans", "Crop tops", "Tunics", "Sweatshirts / Hoodies", "Tank tops"],
            "Bottoms": ["Jeans", "Trousers / Slacks", "Shorts", "Skirts (mini, midi, maxi)", "Leggings", "Culottes", "Joggers / Sweatpants"],
            "Dresses & Jumpsuits": ["Casual dresses", "Evening dresses", "Maxi dresses", "Bodycon dresses", "Shirt dresses", "Jumpsuits", "Playsuits / Rompers", "Gowns"],
            "Outerwear": ["Blazers", "Coats", "Jackets", "Parkas", "Raincoats", "Vests / Gilets"],
            "Activewear & Sportswear": ["Sports T-shirts / Tanks", "Yoga pants / Leggings", "Sports bras", "Tracksuits", "Running jackets"],
            "Loungewear & Sleepwear": ["Pajamas", "Nightgowns", "Robes", "Lounge pants"],
            "Underwear & Intimates": ["Bras", "Panties", "Shapewear", "Camisoles", "Slips"],
            "Swimwear": ["One-piece swimsuits", "Bikinis", "Tankinis", "Swim dresses"],
            "Accessories": ["Hats / Caps", "Scarves", "Gloves", "Belts", "Sunglasses", "Watches", "Bags / Handbags", "Jewelry"]
        };

        // --- Helper Functions ---
        
        /**
         * Displays a temporary alert message to the user.
         * @param {string} message The message to display.
         * @param {string} type The type of alert, 'success' or 'error'.
         */
        function setAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            const colorClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            alertDiv.className = `fixed top-4 left-1/2 -translate-x-1/2 p-3 ${colorClass} text-white rounded-xl shadow-lg z-50 animate-fade-in-down`;
            alertDiv.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }

        /**
         * Converts any image format to a Base64 encoded PNG string.
         * This is useful for consistent data storage.
         * @param {string} base64Image The image data as a Base64 string.
         * @returns {Promise<string>} A promise that resolves with the Base64 PNG data.
         */
        function convertImageToPng(base64Image) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const pngData = canvas.toDataURL('image/png');
                    resolve(pngData);
                };
                img.onerror = (error) => {
                    reject(error);
                };
                img.src = base64Image;
            });
        }

        // --- Core Application Logic (CRUD & In-memory) ---

        /**
         * Sets the selected gender.
         * @param {string} selectedGender 'men' or 'women'.
         */
        async function selectGender(selectedGender) {
            state.gender = selectedGender;
            state.wardrobe = {}; // Reset wardrobe for the new gender
            renderApp();
            setAlert('Gender selected successfully!');
        }

        /**
         * Adds or updates a new clothing item to the wardrobe.
         * @param {string} category The main category (e.g., 'Tops').
         * @param {string} subcategory The subcategory (e.g., 'T-shirts').
         * @param {string} name The item's name.
         * @param {string} imageData The item's image as a Base64 string.
         * @param {string} itemId The ID of the item to edit (null for new items).
         */
        async function addClothingItem(category, subcategory, name, imageData, itemId = null) {
            try {
                if (!imageData) {
                    setAlert('Please upload an image.', 'error');
                    return;
                }

                if (!state.wardrobe[category]) state.wardrobe[category] = {};
                if (!state.wardrobe[category][subcategory]) state.wardrobe[category][subcategory] = [];
                
                let newItem;
                if (itemId) {
                    // Update existing item
                    const itemIndex = state.wardrobe[category][subcategory].findIndex(item => item.id === itemId);
                    if (itemIndex > -1) {
                        state.wardrobe[category][subcategory][itemIndex] = { id: itemId, name: name, base64Image: imageData };
                    }
                } else {
                    // Add new item
                    newItem = {
                        id: crypto.randomUUID(),
                        name: name,
                        base64Image: imageData
                    };
                    state.wardrobe[category][subcategory].push(newItem);
                }

                document.getElementById('add-item-modal').classList.add('hidden');
                document.getElementById('new-item-name').value = '';
                document.getElementById('item-image-upload').value = null;
                document.getElementById('image-preview-container').classList.add('hidden');
                state.selectedImage = null;
                state.editingItem = null;
                renderApp();
                setAlert(itemId ? 'Item updated successfully!' : 'Item added successfully!');
            } catch (error) {
                console.error("Error adding/updating item:", error);
                setAlert('Failed to save item. Please try again.', 'error');
            }
        }

        /**
         * Removes a clothing item from the wardrobe.
         * @param {string} category The main category.
         * @param {string} subcategory The subcategory.
         * @param {string} itemId The ID of the item to remove.
         */
        async function removeClothingItem(category, subcategory, itemId) {
            try {
                if (state.wardrobe[category] && state.wardrobe[category][subcategory]) {
                    state.wardrobe[category][subcategory] = state.wardrobe[category][subcategory].filter(item => item.id !== itemId);
                }
                
                renderApp();
                setAlert('Item removed successfully!');
            } catch (error) {
                console.error("Error removing item:", error);
                setAlert('Failed to remove item. Please try again.', 'error');
            }
        }
        
        // --- Page Render Functions ---

        function renderGenderSelectionPage() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-900 text-white">
                    <h1 class="text-4xl md:text-5xl font-bold mb-8 text-center text-gray-200">
                        Choose Your Digital Wardrobe
                    </h1>
                    <p class="text-xl text-gray-400 mb-12 text-center max-w-xl">
                        To get started, please select your gender. This will set up your clothing categories.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-6">
                        <button id="select-men-gender" class="flex items-center justify-center gap-2 p-6 w-full sm:w-64 bg-indigo-600 hover:bg-indigo-700 transition duration-300 rounded-2xl shadow-lg transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span class="text-lg font-semibold">Man</span>
                        </button>
                        <button id="select-women-gender" class="flex items-center justify-center gap-2 p-6 w-full sm:w-64 bg-pink-600 hover:bg-pink-700 transition duration-300 rounded-2xl shadow-lg transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-2"><path d="M14.5 7H19c2.8 0 5 2.2 5 5s-2.2 5-5 5h-4.5"/><path d="M9.5 17H5c-2.8 0-5-2.2-5-5s2.2-5 5-5h4.5"/><circle cx="12" cy="12" r="3"/></svg>
                            <span class="text-lg font-semibold">Woman</span>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('select-men-gender').addEventListener('click', () => selectGender('men'));
            document.getElementById('select-women-gender').addEventListener('click', () => selectGender('women'));
            document.getElementById('nav-bar').classList.add('hidden');
        }

        function renderWardrobePage() {
            const appDiv = document.getElementById('app');
            const categories = state.gender === 'men' ? menCategories : womenCategories;
            const currentWardrobe = state.wardrobe || {};

            let html = `
                <div class="container mx-auto p-4 md:p-8">
                    <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-200">My Wardrobe</h1>
            `;

            for (const mainCategory in categories) {
                html += `
                    <div class="mb-8">
                        <h2 class="text-xl md:text-2xl font-semibold mb-4 text-indigo-400">${mainCategory}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                `;
                for (const subcategory of categories[mainCategory]) {
                    const items = (currentWardrobe[mainCategory]?.[subcategory] || []);
                    html += `
                            <div class="p-4 bg-gray-800 rounded-xl shadow-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-medium text-gray-300">${subcategory}</h3>
                                    <button class="add-item-btn p-2 bg-indigo-600 rounded-full text-white hover:bg-indigo-500 transition-colors" data-main-cat="${mainCategory}" data-sub-cat="${subcategory}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    `;
                    if (items.length === 0) {
                        html += `<p class="text-gray-500 text-sm italic col-span-full">No items added yet.</p>`;
                    } else {
                        for (const item of items) {
                            html += `
                                        <div class="relative group overflow-hidden rounded-xl shadow-md">
                                            <img src="${item.base64Image}" alt="${item.name}" class="w-full h-24 object-cover" />
                                            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity p-2">
                                                <span class="text-white text-xs font-semibold text-center">${item.name}</span>
                                                <div class="absolute top-2 right-2 flex space-x-1">
                                                    <button class="edit-item-btn p-1 bg-blue-600 rounded-full text-white hover:bg-blue-500 transition-colors" data-main-cat="${mainCategory}" data-sub-cat="${subcategory}" data-item-id="${item.id}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                                    </button>
                                                    <button class="remove-item-btn p-1 bg-red-600 rounded-full text-white hover:bg-red-500 transition-colors" data-main-cat="${mainCategory}" data-sub-cat="${subcategory}" data-item-id="${item.id}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                            `;
                        }
                    }
                    html += `
                                </div>
                            </div>
                    `;
                }
                html += `
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            appDiv.innerHTML = html;

            // Attach event listeners
            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.modalData.category = btn.dataset.mainCat;
                    state.modalData.subcategory = btn.dataset.subCat;
                    state.editingItem = null;
                    document.getElementById('modal-title').textContent = 'Add New Item';
                    document.getElementById('modal-subcategory').textContent = state.modalData.subcategory;
                    document.getElementById('new-item-name').value = '';
                    document.getElementById('item-image-upload').value = null;
                    document.getElementById('image-preview-container').classList.add('hidden');
                    document.getElementById('add-item-button').textContent = 'Add Item';
                    document.getElementById('add-item-button').disabled = true; // Disable button initially
                    document.getElementById('add-item-modal').classList.remove('hidden');
                });
            });
            
            document.querySelectorAll('.edit-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mainCat = btn.dataset.mainCat;
                    const subCat = btn.dataset.subCat;
                    const itemId = btn.dataset.itemId;
                    const itemToEdit = state.wardrobe[mainCat][subCat].find(item => item.id === itemId);

                    if (itemToEdit) {
                        state.editingItem = itemToEdit;
                        state.selectedImage = itemToEdit.base64Image; // Set the selected image for editing
                        state.modalData.category = mainCat;
                        state.modalData.subcategory = subCat;
                        document.getElementById('modal-title').textContent = 'Edit Item';
                        document.getElementById('modal-subcategory').textContent = subCat;
                        document.getElementById('new-item-name').value = itemToEdit.name;
                        document.getElementById('image-preview').src = itemToEdit.base64Image;
                        document.getElementById('image-preview-container').classList.remove('hidden');
                        document.getElementById('add-item-button').textContent = 'Update Item';
                        document.getElementById('add-item-button').disabled = false; // Enable button for editing
                        document.getElementById('add-item-modal').classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    removeClothingItem(btn.dataset.mainCat, btn.dataset.subCat, btn.dataset.itemId);
                });
            });
            
            updateNavActive('nav-wardrobe');
        }

        function renderCreateOutfitPage() {
            const appDiv = document.getElementById('app');
            const categories = state.gender === 'men' ? menCategories : womenCategories;
            const currentWardrobe = state.wardrobe || {};

            const outfitItemsHtml = state.currentOutfit.map((item, index) => `
                <div class="relative group cursor-pointer w-24 h-24">
                    <img src="${item.base64Image}" alt="${item.name}" class="w-full h-full object-contain rounded-xl" style="z-index: ${index + 1};" />
                    <button class="remove-outfit-item-btn absolute -top-2 -right-2 p-1 bg-red-600 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity" data-item-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                    </button>
                </div>
            `).join('');

            let wardrobeItemsHtml = '';
            for (const mainCategory in categories) {
                wardrobeItemsHtml += `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg max-h-64 overflow-y-auto mb-4">
                        <h2 class="text-xl font-semibold mb-3 text-indigo-400">${mainCategory}</h2>
                `;
                for (const subcategory of categories[mainCategory]) {
                    const items = (currentWardrobe[mainCategory]?.[subcategory] || []);
                    if (items.length > 0) {
                        wardrobeItemsHtml += `
                            <div class="mb-4">
                                <h3 class="text-lg font-medium text-gray-300 mb-2">${subcategory}</h3>
                                <div class="flex flex-wrap gap-2">
                        `;
                        for (const item of items) {
                            wardrobeItemsHtml += `
                                    <div class="add-to-outfit-btn relative w-16 h-16 bg-gray-700 rounded-xl shadow-md overflow-hidden cursor-pointer hover:scale-105 transition-transform" data-item-id="${item.id}" data-main-cat="${mainCategory}" data-sub-cat="${subcategory}">
                                        <img src="${item.base64Image}" alt="${item.name}" class="w-full h-full object-cover" />
                                    </div>
                            `;
                        }
                        wardrobeItemsHtml += `
                                </div>
                            </div>
                        `;
                    }
                }
                wardrobeItemsHtml += `</div>`;
            }

            appDiv.innerHTML = `
                <div class="container mx-auto p-4 md:p-8">
                    <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-200">Create an Outfit</h1>
                    <div class="flex flex-col lg:flex-row gap-8">
                        <div class="lg:w-2/3 p-6 bg-gray-800 rounded-xl shadow-lg relative h-[400px] sm:h-[600px] flex items-center justify-center">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-600 text-xl font-bold">
                                
                            </div>
                            <div id="outfit-canvas" class="relative w-full h-full flex flex-col items-center justify-center gap-2 overflow-auto p-4 z-10">
                                ${outfitItemsHtml}
                            </div>
                        </div>
                        <div class="lg:w-1/3 flex flex-col gap-6">
                            ${wardrobeItemsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Attach event listeners
            document.querySelectorAll('.add-to-outfit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mainCat = btn.dataset.mainCat;
                    const subCat = btn.dataset.subCat;
                    const itemId = btn.dataset.itemId;
                    const item = state.wardrobe[mainCat][subCat].find(i => i.id === itemId);
                    if (item) {
                        state.currentOutfit.push(item);
                        renderCreateOutfitPage();
                    }
                });
            });

            document.querySelectorAll('.remove-outfit-item-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemId = btn.dataset.itemId;
                    state.currentOutfit = state.currentOutfit.filter(item => item.id !== itemId);
                    renderCreateOutfitPage();
                });
            });
            
            updateNavActive('nav-create-outfit');
        }


        // Main function to render the app based on state
        function renderApp() {
            const navBar = document.getElementById('nav-bar');
            navBar.classList.remove('hidden');

            if (!state.gender) {
                renderGenderSelectionPage();
                navBar.classList.add('hidden');
            } else {
                switch (state.currentPage) {
                    case 'wardrobe':
                        renderWardrobePage();
                        break;
                    case 'create-outfit':
                        renderCreateOutfitPage();
                        break;
                    default:
                        renderWardrobePage();
                }
            }
        }
        
        function updateNavActive(activeId) {
            document.querySelectorAll('#nav-bar button').forEach(btn => {
                if (btn.id === activeId) {
                    btn.classList.remove('text-gray-400', 'hover:text-indigo-300');
                    btn.classList.add('text-indigo-400');
                } else {
                    btn.classList.remove('text-indigo-400');
                    btn.classList.add('text-gray-400', 'hover:text-indigo-300');
                }
            });
        }

        // --- Event Listeners and Initial Setup ---
        
        // This is the initial setup, without Firebase dependencies
        document.addEventListener('DOMContentLoaded', () => {
            renderApp();

            // Navigation bar listeners
            document.getElementById('nav-wardrobe').addEventListener('click', () => {
                state.currentPage = 'wardrobe';
                renderApp();
            });
            document.getElementById('nav-create-outfit').addEventListener('click', () => {
                state.currentPage = 'create-outfit';
                state.currentOutfit = []; // Clear current outfit when navigating
                renderApp();
            });

            // Add item modal listeners
            const modal = document.getElementById('add-item-modal');
            document.getElementById('close-modal').addEventListener('click', () => {
                modal.classList.add('hidden');
                document.getElementById('new-item-name').value = '';
                document.getElementById('item-image-upload').value = null;
                document.getElementById('image-preview-container').classList.add('hidden');
                state.editingItem = null;
                state.selectedImage = null; // Clear selected image
            });

            const newItemNameInput = document.getElementById('new-item-name');
            const itemImageUploadInput = document.getElementById('item-image-upload');
            const addItemButton = document.getElementById('add-item-button');
            const imagePreview = document.getElementById('image-preview');
            const imagePreviewContainer = document.getElementById('image-preview-container');

            function checkFormValidity() {
                // The button is enabled only if there's a name and an image selected
                addItemButton.disabled = !(newItemNameInput.value.trim() && state.selectedImage);
            }

            newItemNameInput.addEventListener('input', checkFormValidity);

            itemImageUploadInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.selectedImage = e.target.result;
                        imagePreview.src = state.selectedImage;
                        imagePreviewContainer.classList.remove('hidden');
                        checkFormValidity();
                    };
                    reader.readAsDataURL(file);
                } else {
                    state.selectedImage = null;
                    imagePreviewContainer.classList.add('hidden');
                    checkFormValidity();
                }
            });

            addItemButton.addEventListener('click', () => {
                if (state.editingItem) {
                    addClothingItem(
                        state.modalData.category,
                        state.modalData.subcategory,
                        newItemNameInput.value.trim(),
                        state.selectedImage,
                        state.editingItem.id
                    );
                } else {
                    addClothingItem(
                        state.modalData.category,
                        state.modalData.subcategory,
                        newItemNameInput.value.trim(),
                        state.selectedImage
                    );
                }
            });
        });
    </script>
</body>
</html>